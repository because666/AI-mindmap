# DeepMindMap V2 - 项目架构设计文档

## 一、项目概述

### 1.1 项目定位
基于对话节点的结构化思维协作平台，将"对话"作为核心原子单位，通过可视化图谱进行组织、管理与深化，构建新一代思维协作平台。

### 1.2 核心价值
- 将离散的思考与讨论结构化为可生长、可互联的动态知识网络
- 支持复杂项目规划、创意发散与深度思考
- 提供思维过程的可视化、可操作、可演进的结构

## 二、技术栈

### 2.1 前端技术
| 技术 | 版本 | 用途 |
|------|------|------|
| React | 18.x | 核心UI框架 |
| TypeScript | 5.x | 类型安全 |
| React Flow | 11.x | 思维图谱可视化 |
| Zustand | 4.x | 状态管理 |
| TailwindCSS | 3.x | 样式框架 |
| React Router | 6.x | 路由管理 |
| Axios | 1.x | HTTP客户端 |
| Socket.io-client | 4.x | 实时通信 |

### 2.2 后端技术
| 技术 | 版本 | 用途 |
|------|------|------|
| Node.js | 20.x LTS | 运行环境 |
| Express | 4.x | Web框架 |
| TypeScript | 5.x | 类型安全 |
| MongoDB | 7.x | 主数据库 |
| Mongoose | 8.x | ODM |
| Socket.io | 4.x | 实时通信 |
| JWT | - | 身份认证 |

### 2.3 AI服务集成
| 服务商 | 模型 | 用途 |
|--------|------|------|
| OpenAI | GPT-4/GPT-3.5 | 对话生成 |
| Anthropic | Claude 3 | 长文本处理 |
| 本地模型 | - | 可扩展支持 |

## 三、系统架构

### 3.1 整体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                        客户端层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  画布组件   │  │  对话组件   │  │  管理组件   │         │
│  │ (React Flow)│  │  (Chat UI)  │  │  (Sidebar)  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              状态管理层 (Zustand)                    │   │
│  │  - 节点状态  - 对话状态  - UI状态  - 用户状态       │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP / WebSocket
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        服务端层                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                  API Gateway                         │   │
│  │  - 认证中间件  - 请求验证  - 限流控制               │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  节点服务   │  │  对话服务   │  │  AI服务     │         │
│  │  NodeService│  │ ChatService │  │  AIService  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  关系服务   │  │  搜索服务   │  │  历史服务   │         │
│  │RelationSvc  │  │ SearchSvc   │  │ HistorySvc  │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        数据层                                │
│  ┌─────────────────────┐  ┌─────────────────────┐          │
│  │      MongoDB        │  │    文件存储         │          │
│  │  - 节点数据         │  │  - 附件存储         │          │
│  │  - 对话数据         │  │  - 导出文件         │          │
│  │  - 关系数据         │  │                     │          │
│  └─────────────────────┘  └─────────────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 目录结构
```
deep-mind-map/
├── client/                          # 前端项目
│   ├── src/
│   │   ├── components/              # 组件目录
│   │   │   ├── Canvas/              # 画布相关组件
│   │   │   │   ├── NodeCanvas.tsx   # 主画布组件
│   │   │   │   ├── CustomNode/      # 自定义节点
│   │   │   │   ├── CustomEdge/      # 自定义边
│   │   │   │   └── Controls/        # 画布控制
│   │   │   ├── Chat/                # 对话相关组件
│   │   │   │   ├── ChatPanel.tsx    # 对话面板
│   │   │   │   ├── MessageList.tsx  # 消息列表
│   │   │   │   └── InputArea.tsx    # 输入区域
│   │   │   ├── Sidebar/             # 侧边栏组件
│   │   │   ├── Modal/               # 弹窗组件
│   │   │   └── Common/              # 通用组件
│   │   ├── stores/                  # 状态管理
│   │   │   ├── nodeStore.ts         # 节点状态
│   │   │   ├── chatStore.ts         # 对话状态
│   │   │   ├── uiStore.ts           # UI状态
│   │   │   └── userStore.ts         # 用户状态
│   │   ├── services/                # API服务
│   │   │   ├── api.ts               # API基础配置
│   │   │   ├── nodeService.ts       # 节点API
│   │   │   ├── chatService.ts       # 对话API
│   │   │   └── aiService.ts         # AI服务API
│   │   ├── hooks/                   # 自定义Hooks
│   │   ├── utils/                   # 工具函数
│   │   ├── types/                   # 类型定义
│   │   ├── styles/                  # 样式文件
│   │   ├── App.tsx                  # 应用入口
│   │   └── main.tsx                 # 主入口
│   ├── public/                      # 静态资源
│   ├── package.json
│   └── vite.config.ts
│
├── server/                          # 后端项目
│   ├── src/
│   │   ├── controllers/             # 控制器
│   │   │   ├── nodeController.ts    # 节点控制器
│   │   │   ├── chatController.ts    # 对话控制器
│   │   │   ├── relationController.ts# 关系控制器
│   │   │   └── authController.ts    # 认证控制器
│   │   ├── services/                # 业务逻辑
│   │   │   ├── nodeService.ts       # 节点服务
│   │   │   ├── chatService.ts       # 对话服务
│   │   │   ├── relationService.ts   # 关系服务
│   │   │   ├── aiService.ts         # AI服务
│   │   │   ├── searchService.ts     # 搜索服务
│   │   │   └── historyService.ts    # 历史服务
│   │   ├── models/                  # 数据模型
│   │   │   ├── Node.ts              # 节点模型
│   │   │   ├── Conversation.ts      # 对话模型
│   │   │   ├── Relation.ts          # 关系模型
│   │   │   ├── User.ts              # 用户模型
│   │   │   └── History.ts           # 历史模型
│   │   ├── routes/                  # 路由定义
│   │   ├── middlewares/             # 中间件
│   │   ├── utils/                   # 工具函数
│   │   ├── types/                   # 类型定义
│   │   ├── config/                  # 配置文件
│   │   └── app.ts                   # 应用入口
│   ├── package.json
│   └── tsconfig.json
│
├── docs/                            # 文档目录
├── scripts/                         # 脚本目录
└── docker-compose.yml               # Docker配置
```

## 四、数据模型设计

### 4.1 节点模型 (Node)
```typescript
interface INode {
  _id: ObjectId;
  workspaceId: ObjectId;           // 所属工作区
  type: 'root' | 'branch' | 'leaf' | 'composite';  // 节点类型
  title: string;                   // 节点标题
  summary: string;                 // 节点摘要（用于预览）
  
  // 层级关系
  parentIds: ObjectId[];           // 多父节点支持
  childrenIds: ObjectId[];         // 子节点列表
  
  // 复合节点相关
  isComposite: boolean;            // 是否为复合节点
  compositeChildren?: ObjectId[];  // 复合节点包含的子节点
  
  // 画布位置
  position: {
    x: number;
    y: number;
  };
  
  // 元数据
  createdAt: Date;
  updatedAt: Date;
  createdBy: ObjectId;
  
  // 状态
  status: 'active' | 'archived' | 'deleted';
  tags: string[];
}
```

### 4.2 对话模型 (Conversation)
```typescript
interface IConversation {
  _id: ObjectId;
  nodeId: ObjectId;                // 所属节点
  
  messages: IMessage[];            // 消息列表
  
  // 上下文配置
  contextConfig: {
    includeParentHistory: boolean; // 是否包含父节点历史
    includeRelatedNodes: ObjectId[]; // 关联节点
    customContext?: string;        // 自定义上下文
  };
  
  // AI配置
  aiConfig: {
    provider: 'openai' | 'claude' | 'local';
    model: string;
    temperature: number;
    maxTokens: number;
  };
  
  createdAt: Date;
  updatedAt: Date;
}

interface IMessage {
  _id: ObjectId;
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: Date;
  metadata?: {
    tokens?: number;
    model?: string;
  };
}
```

### 4.3 关系模型 (Relation)
```typescript
interface IRelation {
  _id: ObjectId;
  workspaceId: ObjectId;
  
  sourceNodeId: ObjectId;          // 源节点
  targetNodeId: ObjectId;          // 目标节点
  
  type: RelationType;              // 关系类型
  description?: string;            // 关系描述
  
  createdAt: Date;
  createdBy: ObjectId;
}

type RelationType = 
  | 'supports'      // 支持
  | 'contradicts'   // 矛盾
  | 'prerequisite'  // 前提
  | 'elaborates'    // 细化
  | 'references'    // 参考
  | 'conclusion'    // 结论
  | 'custom';       // 自定义
```

### 4.4 工作区模型 (Workspace)
```typescript
interface IWorkspace {
  _id: ObjectId;
  name: string;
  description?: string;
  
  ownerId: ObjectId;
  members: {
    userId: ObjectId;
    role: 'owner' | 'admin' | 'editor' | 'viewer';
  }[];
  
  settings: {
    defaultAIProvider: string;
    defaultModel: string;
  };
  
  createdAt: Date;
  updatedAt: Date;
}
```

### 4.5 历史记录模型 (History)
```typescript
interface IHistory {
  _id: ObjectId;
  workspaceId: ObjectId;
  
  operation: {
    type: 'create' | 'update' | 'delete' | 'move' | 'connect';
    entityType: 'node' | 'relation' | 'conversation';
    entityId: ObjectId;
    beforeData?: any;
    afterData?: any;
  };
  
  timestamp: Date;
  userId: ObjectId;
  
  // 快照支持
  snapshot?: ObjectId;             // 关联的快照ID
}

interface ISnapshot {
  _id: ObjectId;
  workspaceId: ObjectId;
  name: string;
  description?: string;
  
  data: {
    nodes: INode[];
    relations: IRelation[];
    conversations: IConversation[];
  };
  
  createdAt: Date;
  createdBy: ObjectId;
}
```

## 五、API接口设计

### 5.1 节点相关接口

#### 创建节点
```
POST /api/nodes
Request:
{
  "workspaceId": "string",
  "title": "string",
  "parentIds": ["string"],
  "type": "root|branch|leaf",
  "position": { "x": number, "y": number }
}
Response:
{
  "success": true,
  "data": { ...node }
}
```

#### 获取节点详情
```
GET /api/nodes/:nodeId
Response:
{
  "success": true,
  "data": {
    "node": { ... },
    "conversation": { ... },
    "relations": [ ... ]
  }
}
```

#### 更新节点
```
PUT /api/nodes/:nodeId
Request:
{
  "title": "string",
  "position": { "x": number, "y": number },
  "parentIds": ["string"]
}
```

#### 删除节点
```
DELETE /api/nodes/:nodeId
```

#### 获取工作区节点树
```
GET /api/workspaces/:workspaceId/nodes
Response:
{
  "success": true,
  "data": {
    "nodes": [ ... ],
    "edges": [ ... ]
  }
}
```

### 5.2 对话相关接口

#### 发送消息
```
POST /api/conversations/:conversationId/messages
Request:
{
  "content": "string",
  "contextConfig": { ... }
}
Response (Streaming):
{
  "type": "content",
  "content": "string"
}
```

#### 获取对话历史
```
GET /api/conversations/:conversationId/messages
Query: ?page=1&limit=50
```

#### 提炼结论
```
POST /api/conversations/:conversationId/extract-conclusion
Request:
{
  "title": "string",
  "targetNodeId": "string"
}
```

### 5.3 关系相关接口

#### 创建关系
```
POST /api/relations
Request:
{
  "sourceNodeId": "string",
  "targetNodeId": "string",
  "type": "supports|contradicts|...",
  "description": "string"
}
```

#### 获取节点关系
```
GET /api/nodes/:nodeId/relations
```

### 5.4 搜索接口

#### 全局搜索
```
GET /api/search
Query: ?q=keyword&workspaceId=xxx&type=node|conversation
```

### 5.5 历史相关接口

#### 获取操作历史
```
GET /api/workspaces/:workspaceId/history
Query: ?page=1&limit=50
```

#### 创建快照
```
POST /api/workspaces/:workspaceId/snapshots
Request:
{
  "name": "string",
  "description": "string"
}
```

#### 回滚到快照
```
POST /api/snapshots/:snapshotId/restore
```

## 六、模块划分

### 6.1 前端模块

| 模块名称 | 功能描述 | 核心组件 |
|----------|----------|----------|
| 画布模块 | 思维图谱可视化展示与操作 | NodeCanvas, CustomNode, CustomEdge, MiniMap |
| 对话模块 | 节点内对话交互 | ChatPanel, MessageList, InputArea, ContextConfig |
| 节点管理模块 | 节点CRUD操作 | NodeCreator, NodeEditor, NodeTree |
| 关系管理模块 | 节点关系管理 | RelationEditor, RelationTypeSelector |
| 搜索模块 | 全局搜索功能 | SearchBar, SearchResult |
| 历史模块 | 操作历史与版本管理 | HistoryPanel, SnapshotManager |
| 用户模块 | 用户认证与设置 | Login, Register, Settings |
| 工作区模块 | 工作区管理 | WorkspaceList, WorkspaceSettings |

### 6.2 后端模块

| 模块名称 | 功能描述 | 核心服务 |
|----------|----------|----------|
| 认证模块 | 用户身份验证 | AuthService, JWTService |
| 节点模块 | 节点数据管理 | NodeService, NodeTreeService |
| 对话模块 | 对话与AI交互 | ChatService, AIProviderService |
| 关系模块 | 节点关系管理 | RelationService |
| 搜索模块 | 全文检索 | SearchService |
| 历史模块 | 操作记录与快照 | HistoryService, SnapshotService |
| 上下文模块 | 智能上下文构建 | ContextBuilderService |
| WebSocket模块 | 实时通信 | SocketService |

## 七、核心功能实现策略

### 7.1 多父节点实现
```typescript
// 获取节点完整上下文
async function buildNodeContext(nodeId: string): Promise<Context> {
  const node = await Node.findById(nodeId);
  const context: Context = {
    conversations: [],
    relatedNodes: []
  };
  
  // 递归获取所有父节点上下文
  for (const parentId of node.parentIds) {
    const parentContext = await buildNodeContext(parentId);
    context.conversations.push(...parentContext.conversations);
  }
  
  // 获取当前节点对话
  const conversation = await Conversation.findOne({ nodeId });
  context.conversations.push(conversation);
  
  return context;
}
```

### 7.2 关系类型上下文处理
```typescript
// 根据关系类型调整上下文权重
function adjustContextByRelation(
  context: Context,
  relation: Relation
): Context {
  const weights = {
    'supports': 1.0,
    'contradicts': -0.5,  // 矛盾关系降低权重
    'prerequisite': 1.5,  // 前提关系提高权重
    'elaborates': 0.8,
    'references': 0.6,
    'conclusion': 1.2
  };
  
  return {
    ...context,
    weight: weights[relation.type] || 1.0
  };
}
```

### 7.3 复合节点实现
```typescript
// 聚合节点为复合节点
async function createCompositeNode(
  nodeIds: string[],
  title: string
): Promise<Node> {
  const nodes = await Node.find({ _id: { $in: nodeIds } });
  
  const compositeNode = await Node.create({
    type: 'composite',
    title,
    isComposite: true,
    compositeChildren: nodeIds,
    position: calculateCenterPosition(nodes)
  });
  
  // 隐藏原子节点
  await Node.updateMany(
    { _id: { $in: nodeIds } },
    { $set: { hidden: true, compositeParent: compositeNode._id } }
  );
  
  return compositeNode;
}
```

### 7.4 历史版本管理
```typescript
// 创建快照
async function createSnapshot(workspaceId: string): Promise<Snapshot> {
  const [nodes, relations, conversations] = await Promise.all([
    Node.find({ workspaceId }),
    Relation.find({ workspaceId }),
    Conversation.find({ workspaceId })
  ]);
  
  return Snapshot.create({
    workspaceId,
    data: { nodes, relations, conversations },
    createdAt: new Date()
  });
}

// 回滚快照
async function restoreSnapshot(snapshotId: string): Promise<void> {
  const snapshot = await Snapshot.findById(snapshotId);
  
  // 清空当前数据
  await Promise.all([
    Node.deleteMany({ workspaceId: snapshot.workspaceId }),
    Relation.deleteMany({ workspaceId: snapshot.workspaceId }),
    Conversation.deleteMany({ workspaceId: snapshot.workspaceId })
  ]);
  
  // 恢复快照数据
  await Promise.all([
    Node.insertMany(snapshot.data.nodes),
    Relation.insertMany(snapshot.data.relations),
    Conversation.insertMany(snapshot.data.conversations)
  ]);
}
```

## 八、开发时间表

### 阶段一：基础架构搭建（第1-2周）
- [ ] 项目初始化与配置
- [ ] 数据库设计与模型定义
- [ ] 基础API框架搭建
- [ ] 前端项目结构搭建
- [ ] 认证系统实现

### 阶段二：核心功能开发（第3-6周）
- [ ] 节点管理功能
  - 节点创建、编辑、删除
  - 多父节点支持
  - 节点树结构
- [ ] 画布可视化功能
  - React Flow集成
  - 自定义节点组件
  - 拖拽与缩放
- [ ] 对话功能
  - 对话UI组件
  - AI服务集成
  - 流式响应处理

### 阶段三：高级功能开发（第7-10周）
- [ ] 关系管理功能
  - 关系类型定义
  - 关系可视化
  - 上下文影响处理
- [ ] 智能上下文系统
  - 上下文构建算法
  - 关系权重计算
  - 结论提炼功能
- [ ] 复合节点功能
  - 节点聚合
  - 展开/折叠
  - 层级管理

### 阶段四：辅助功能开发（第11-12周）
- [ ] 搜索功能
  - 全文检索
  - 结果高亮
- [ ] 历史版本功能
  - 操作记录
  - 快照管理
  - 版本回滚
- [ ] 导入导出功能

### 阶段五：优化与测试（第13-14周）
- [ ] 性能优化
  - 大规模节点渲染优化
  - 虚拟滚动
  - 懒加载
- [ ] 单元测试
- [ ] 集成测试
- [ ] 用户测试与反馈

### 阶段六：部署与上线（第15周）
- [ ] 生产环境配置
- [ ] 部署脚本
- [ ] 监控与日志
- [ ] 文档完善

## 九、技术风险与应对

| 风险 | 影响 | 应对策略 |
|------|------|----------|
| 大规模节点性能问题 | 画布渲染卡顿 | 实现虚拟化渲染、节点懒加载 |
| AI响应延迟 | 用户体验差 | 实现流式响应、本地缓存 |
| 复杂上下文构建 | 响应时间过长 | 实现上下文缓存、增量更新 |
| 数据一致性 | 多用户协作冲突 | 实现乐观锁、冲突解决机制 |

## 十、后续扩展规划

1. **协作功能**：多用户实时协作编辑
2. **移动端支持**：响应式设计或原生App
3. **插件系统**：支持第三方功能扩展
4. **知识图谱导出**：支持多种格式导出
5. **AI辅助分析**：自动发现节点间关系
